<html>
<head>
<title>exploring constraint-based motion</title>
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
<style>
* { box-sizing: border-box; }
body {
    font-family: 'Source Sans Pro';
    background-color: #404040;
    color: white;
    text-align: center;
}
.title {
    padding: 15px;
    font-size: 20px;
}
.container {
    text-align: left;
    position: relative;
    margin: auto;
    width: 320px;
    height: 480px;
    font-family: 'Roboto', sans-serif;
    background-image: url(img/gmaps-map.png);
    overflow: hidden;
}
.container>* { pointer-events: none; }
.box {
    position: absolute;
    top: 0; left: 0;
}
.photo {
    background-image: url(img/gmaps-image.jpg);
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    overflow: hidden;
}
.photo-dimming-layer {
    background-image: linear-gradient(0deg, transparent, rgba(0, 0, 0, 0.7));
}
.shadow {
    background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.35), transparent);
}
.infobar {
    background-color: #1976d2;
    overflow: hidden;
    padding: 15px;
}
.top-navbar {
    background-image: linear-gradient(0deg, transparent, #1976d2 15%, #1976d2);
    padding: 15px 60px;
    line-height: 25px;
    font-weight: bold;
}
.content {
    overflow: hidden;
    background-color: white;
    color: black;
}

/* This is just style to make the content of the form look nice; it has nothing to do with
   constraints or any of the things that really move. */
.time {
    position: absolute;
    right: 15px;
    top: 15px;
}

.section {
    border-top: 1px solid #eee;
    padding: 15px;
}
.streetview, .morephotos {
    display: inline-block;
    width: 48%;
    height: 80px;
    background-size: cover;
    color: white;
    line-height: 130px;
    padding: 4px;
}
.streetview { background-image: linear-gradient(0deg, rgba(0,0,0,0.5), transparent), url(img/gmaps-streetview.jpg); }
.morephotos { background-image: linear-gradient(0deg, rgba(0,0,0,0.5), transparent), url(img/gmaps-image2.jpg); }
.explain {
    color: black;
    display: inline-block;
    margin-top: 50px;
    margin-bottom: 50px;
    background-color: white;
    width: 80%;
    border-radius: 10px;
    padding: 20px;
    text-align: left;
}
.explain pre {
    display: inline;
    white-space: normal;
}
</style>
<script src="touch.js"></script>
<script src="../physics/animate.js"></script>
<script src="../physics/friction.js"></script>
<script src="../physics/spring.js"></script>
<script src="../physics/gravity.js"></script>
<script src="c.js"></script>
<script src="manipulator.js"></script>
<script src="multieditsolver.js"></script>
<script src="motioncontext.js"></script>
<script src="motionconstraint.js"></script>
<script src="box.js"></script>
<script src="gmaps.js"></script>
</head>
<body>
<div class="title">
Google Maps example&mdash;Drag the blue box upwards.
</div>
<div class="container">
    <div class="form box">
        <div class="shadow box"></div>
        <div class="photo box">
            <div class="photo-dimming-layer box"></div>
        </div>
        <div class="content box">
            <div class="section"><i>Grassy park with tennis/handball courts, horseshoe pits, playgrounds, splash pad &amp; a fenced dog run.</i></div>
            <div class="section">600 East Meadow Drive, Palo Alto, CA 94306</div>
            <div class="section">Open 24 hours</div>
            <div class="section">More Info...</div>
            <div class="section">Suggest an edit</div>
            <div class="section">
                <div class="streetview">Street View</div>
                <div class="morephotos">26 Photos</div>
                Add a photo...
            </div>
            <div class="section">Review Summary</div>
            <div class="section">Reviews</div>
        </div>
        <div class="infobar box">
            <div class="small-title">Mitchell Park</div>
            <div class="rating">4.5 stars</div>
            <div class="time">5 minutes</div>
            <div class="top-navbar box">
                <span class="top-title">Mitchell Park</span>
            </div>
        </div>
        <div class="navigation-controls box"></div>
    </div>
</div>
<div class="explain">
<b>Drag upwards on the blue box to reveal more information, keep dragging to scroll.</b>
<br>
This is a reproduction of a touch interaction in Google Maps on Android and iOS using constraints and motion constraints. Here's the cast of objects that move:
<ul>
 <li><b>infoBar</b>&mdash;the blue box with the summary information</li>
 <li><b>topNavbar</b>&mdash;the bold "Mitchell Park" text that shows up at the very top of the UI when the photo is scrolled away</li>
 <li><b>photo</b>&mdash;the large cover photo</li>
 <li><b>shadow</b>&mdash;the shadow cast by the photo on the map</li>
 <li><b>photoDimmingLayer</b>&mdash;the gradient at the top of the screen that only shows over the photo</li>
 <li><b>content</b>&mdash;the full information on the park, the scrollable data</li>
</ul>
These are the constraints enforced upon them:
<ul>
 <li><pre>infoBar.bottom = screenHeight</pre> the bottom of the infoBar is weakly at the bottom of the UI</li>
 <li><pre>infoBar.y = infoBar.bottom - 80</pre> the info bar is 80px tall (I need to support a "height" property properly...)</li>
 <li><pre>infoBar.bottom = screenHeight + scrollPosition</pre> the infoBar moves up and down with the scroll position</li>
 <li><pre>photo.y = infoBar.y + scrollPosition * (screenHeight - photoHeight) / screenHeight</pre> the photo's top is aligned with the infoBar's top, but the scroll position causes it to move faster (the ratio is so that the photo will be fully revealed when it reaches the top of the UI)</li>
 <li><pre>photo.bottom = photo.y + photoHeight</pre> give the photo its height (again, need a crisper height concept)</li>
 <li><pre>photo.y &gt;= infoBar.y + scrollPosition * ((screenHeight / photoHeight) / screenHeight) * 0.2</pre> this causes the photo to slowly track upwards when the infoBar is dragged upwards from its middle position. The real Google Maps app just leaves the photo in place, which is a simpler rule: <pre>photo.y &gt;= 0</pre>. I liked the way this one looked better...</li>
 <li><pre>content.y = screenHeight + scrollPosition</pre> the content starts at the bottom of the screen and tracks scroll position</li>
 <li><pre>content.bottom = content.y + contentHeight</pre> give the content its height</li>
</ul>
So we used <b>only eight</b> constraints, and that got us all of the relative motion as well as the basic 2D layout. Now we can start adding motion constraints to limit how far we can drag things with physics simulations...
<ul>
 <li><pre>infoBar.bottom &lt;= screenHeight spring</pre> don't allow the infoBar off the bottom of the screen.</li>
 <li><pre>content.bottom &gt;= screenHeight spring</pre> don't allow the bottom of the content above the bottom of the screen.</li>
</ul>
Now we can't drag off of the ends, we just need to ensure that we can't leave the UI in a bad mid-state. I don't have a good expression for snap positions yet, so the rules are expressed with a few lines of code currently, but still in terms of constraints. We say:
<ul>
 <li>when animating if <pre>photo.y &gt;= 0</pre> then snap it to either the bottom position (<pre>screenHeight - infoBar's height</pre>) or to zero, the top position.</li>
 <li>when animating if <pre>photo.y &lt;= 0</pre> then snap the infoBar to either the middle position or the top position.</li>
</ul>
This ensures that our UI doesn't stop in bad mid-positions. I'm going to come up with a way of expressing these complicated snapping rules more clearly soon. They are expressed in terms of a single variable, but they frequently need to consult other variables.
</div>
</body>
</html>
